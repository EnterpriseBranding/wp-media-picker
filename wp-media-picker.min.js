/*!
 * WP Media Picker - version 0.7.0
 * 
 * Felix Arntz <felix-arntz@leaves-and-love.net>
 */
!function(a,b,c){var d,e,f;if(void 0===b||void 0===b.media)return a.fn.wpMediaPicker=function(){return this},void console.error("WP Media not found");d=b.media.view.MediaFrame.Select,e=d.extend({initialize:function(){c.defaults(this.options,{query:{},multiple:!1,editable:!0,filterable:"all",searchable:!0,displaySettings:!1,displayUserSettings:!1,editing:!1,state:"insert",metadata:{}}),d.prototype.initialize.apply(this,arguments)},createStates:function(){this.states.add([new b.media.controller.Library({id:"insert",title:this.options.title,selection:this.options.selection,priority:20,toolbar:"main-insert",filterable:this.options.filterable,searchable:this.options.searchable,library:b.media.query(this.options.query),multiple:this.options.multiple,editable:this.options.editable,displaySettings:this.options.displaySettings,displayUserSettings:this.options.displayUserSettings}),new b.media.controller.EditImage({model:this.options.editImage})])},bindHandlers:function(){d.prototype.bindHandlers.apply(this,arguments),this.on("toolbar:create:main-insert",this.createToolbar,this),this.on("content:render:edit-image",this.renderEditImageContent,this),this.on("toolbar:render:main-insert",this.renderMainInsertToolbar,this)},renderEditImageContent:function(){var a=new b.media.view.EditImage({controller:this,model:this.state().get("image")}).render();this.content.set(a),a.loadEditor()},renderMainInsertToolbar:function(a){var b=this;a.set("insert",{style:"primary",priority:80,text:b.options.buttonText,requires:{selection:!0},click:function(){b.close(),b.state().trigger("insert",b.state().get("selection")).reset()}})}}),f={options:{store:"id",query:{},multiple:!1,filterable:"all",searchable:!0,editable:!1,displaySettings:!1,displayUserSettings:!1,change:!1,clear:!1,label_add:b.media.view.l10n.addMedia,label_replace:b.media.view.l10n.replace,label_remove:b.media.view.l10n.remove,label_modal:b.media.view.l10n.addMedia,label_button:b.media.view.l10n.addMedia},_create:function(){var c=this;a.extend(c.options,c.element.data()),c.content_id="wp-mediapicker-content-"+c.element.attr("id"),c.element.hide().wrap('<div class="wp-mediapicker-container" />'),c.wrap=c.element.parent(),c.open_button=a('<a class="wp-mediapicker-open-button button" />').insertAfter(c.element),c.remove_button=a('<a class="wp-mediapicker-remove-button" />').insertAfter(c.open_button).text(c.options.label_remove),c.content_wrap=a('<div class="wp-mediapicker-content-wrap" />').insertAfter(c.remove_button),c.content=a('<div class="wp-mediapicker-content" />').appendTo(c.content_wrap).attr("id",c.content_id),c.frame=new e({title:c.options.label_modal,buttonText:c.options.label_button,frame:"select",state:"insert",selection:new b.media.model.Selection([],{multiple:c.options.multiple}),query:c.options.query,multiple:c.options.multiple,filterable:c.options.filterable,searchable:c.options.searchable,editable:c.options.editable}),c._updateContent(),c._addListeners()},_addListeners:function(){var b=this;b.frame.on("insert",function(){var d={};c.extend(d,b.frame.state().get("selection").first().toJSON()),"url"===b.options.store?b.element.val(d.url):b.element.val(d.id),b._createContent(d),"function"==typeof b.options.change&&b.options.change.call(b),a(document).trigger("wpMediaPicker.updateField",[d,b])}),b.open_button.on("click",function(){b.frame.state("insert").get("selection").reset(b.attachment?[b.attachment]:[]),b.open()}),b.remove_button.on("click",function(){b.element.val(null),b._resetContent(),"function"==typeof b.options.clear&&b.options.clear.call(b)})},_createContent:function(a){var b=this;b.attachment=a,b.open_button.text(b.options.label_replace),b.remove_button.show();var c="";if("image"===a.type){var d=a.url;a.sizes&&a.sizes.large?d=a.sizes.large.url:a.sizes&&a.sizes.full&&(d=a.sizes.full.url),c+='<img src="'+d+'" alt="'+a.alt+'" />'}else if("video"===a.type){var e="";a.image&&a.image.src!==a.icon&&(e=a.image.src),c+='<video class="wp-video-shortcode" preload="metadata"'+(e?' poster="'+e+'"':"")+' controls><source type="'+a.mime+'" src="'+a.url+'" /></video>'}else"audio"===a.type?(a.image&&a.image.src&&a.image.src!==a.icon?c+='<img class="wp-audio-cover" src="'+a.image.src+'" alt="'+a.filename+'" />':c+='<div class="mime-type-icon"><img src="'+a.icon+'" /><span>'+a.filename+"</span></div>",c+='<audio class="wp-audio-shortcode" width="100%" preload="none" controls><source type="'+a.mime+'" src="'+a.url+'" /></audio>'):c+='<div class="mime-type-icon"><img src="'+a.icon+'" /><span>'+a.filename+"</span></div>";0<=c.search("<img ")?b.content.addClass("size-auto"):b.content.removeClass("size-auto"),b.content.show().html(c)},_resetContent:function(){var a=this;a.attachment=null,a.open_button.text(a.options.label_add),a.remove_button.hide(),a.content.hide().empty().removeClass("size-auto")},_updateContent:function(){var c,d=this,e=d.element.val();e?(c="url"===d.options.store?{action:"get-attachment-by-url",url:e}:{action:"get-attachment",id:parseInt(e,10)},b.media.ajax({type:"POST",data:c,success:function(b){d._createContent(b),a(document).trigger("wpMediaPicker.updateField",[b,this])},error:function(){d.element.val(null),d._resetContent(),a(document).trigger("wpMediaPicker.updateField",[void 0,this])}})):(d.element.val(null),d._resetContent(),a(document).trigger("wpMediaPicker.updateField",[void 0,this]))},open:function(){b.media.frame=this.frame,this.frame.open(),this.frame.$el.find(".media-frame-menu .media-menu-item.active").focus()},close:function(){this.frame.close()},attachment:function(b){if(void 0===b)return this.attachment;b?("url"===this.options.store?this.element.val(b.url):this.element.val(b.id),this._createContent(b)):(this.element.val(null),this._resetContent()),a(document).trigger("wpMediaPicker.updateField",[b,this])},value:function(a){if(void 0===a)return this.attachment?"url"===this.options.store?this.attachment.url:this.attachment.id:"";this.element.val(a),this._updateContent()},frame:function(){return this.frame}},a.widget("wp.wpMediaPicker",f)}(jQuery,wp,_);