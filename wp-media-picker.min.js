/*!
 * WP Media Picker - version 0.7.0
 * 
 * Felix Arntz <felix-arntz@leaves-and-love.net>
 */
!function(a,b,c){function d(a,c,d,e){var f;if(!a)return void e();f="url"===c?{action:"get-attachment-by-url",url:a}:{action:"get-attachment",id:parseInt(a,10)},b.media.ajax({type:"POST",data:f,success:d,error:e})}var e,f,g;if(void 0===b||void 0===b.media)return a.fn.wpMediaPicker=function(){return this},void console.error("WP Media not found");e=b.media.view.MediaFrame.Select,f=e.extend({initialize:function(){c.defaults(this.options,{query:{},multiple:!1,editable:!0,filterable:"all",searchable:!0,displaySettings:!1,displayUserSettings:!1,editing:!1,state:"insert",metadata:{}}),e.prototype.initialize.apply(this,arguments)},createStates:function(){this.states.add([new b.media.controller.Library({id:"insert",title:this.options.title,selection:this.options.selection,priority:20,toolbar:"main-insert",filterable:this.options.filterable,searchable:this.options.searchable,library:b.media.query(this.options.query),multiple:this.options.multiple,editable:this.options.editable,displaySettings:this.options.displaySettings,displayUserSettings:this.options.displayUserSettings}),new b.media.controller.EditImage({model:this.options.editImage})])},bindHandlers:function(){e.prototype.bindHandlers.apply(this,arguments),this.on("toolbar:create:main-insert",this.createToolbar,this),this.on("content:render:edit-image",this.renderEditImageContent,this),this.on("toolbar:render:main-insert",this.renderMainInsertToolbar,this)},renderEditImageContent:function(){var a=new b.media.view.EditImage({controller:this,model:this.state().get("image")}).render();this.content.set(a),a.loadEditor()},renderMainInsertToolbar:function(a){var b=this;a.set("insert",{style:"primary",priority:80,text:b.options.buttonText,requires:{selection:!0},click:function(){b.close(),b.state().trigger("insert",b.state().get("selection")).reset()}})}}),g={options:{store:"id",query:{},multiple:!1,filterable:"all",searchable:!0,editable:!1,displaySettings:!1,displayUserSettings:!1,change:!1,clear:!1,label_add:b.media.view.l10n.addMedia,label_replace:b.media.view.l10n.replace,label_remove:b.media.view.l10n.remove,label_modal:b.media.view.l10n.addMedia,label_button:b.media.view.l10n.addMedia},_create:function(){var c=this;a.extend(c.options,c.element.data()),c.options.query&&c.options.query.post_mime_type&&(c.options.query.type=c.options.query.post_mime_type,delete c.options.query.post_mime_type),c.content_id="wp-mediapicker-content-"+c.element.attr("id"),c.element.hide().wrap('<div class="wp-mediapicker-container" />'),c.wrap=c.element.parent(),c.open_button=a('<button type="button" class="wp-mediapicker-open-button button" />').insertAfter(c.element),c.remove_button=a('<button type="button" class="wp-mediapicker-remove-button button-link button-link-delete" />').hide().insertAfter(c.open_button).text(c.options.label_remove),c.content_wrap=a('<div class="wp-mediapicker-content-wrap" />').insertAfter(c.remove_button),c.content=a('<div class="wp-mediapicker-content" />').appendTo(c.content_wrap).attr("id",c.content_id),c.frame=new f({title:c.options.label_modal,buttonText:c.options.label_button,frame:"select",state:"insert",selection:new b.media.model.Selection([],{multiple:c.options.multiple}),query:c.options.query,multiple:c.options.multiple,filterable:c.options.filterable,searchable:c.options.searchable,editable:c.options.editable}),c._setValue(c.element.val()),c._addListeners()},_addListeners:function(){var b=this;b.frame.on("insert",function(){var d=b.frame.state().get("selection"),e=d.models.map(function(a){return c.extend({},a.toJSON())}),f=c.extend({},d.first().toJSON());b._setAttachment(f),a(document).trigger("wpMediaPicker.insert",[e,b])}),b.open_button.on("click",function(){b.frame.state("insert").get("selection").reset(b.attachment?[b.attachment]:[]),b.open()}),b.remove_button.on("click",function(){b._setAttachment(null)})},_createContent:function(a){var b=this;b.attachment=a,b.open_button.text(b.options.label_replace),b.remove_button.show();var c="";if("video"===a.type){var d="";a.image&&a.image.src!==a.icon&&(d=a.image.src),c+='<video class="wp-video-shortcode" preload="metadata"'+(d?' poster="'+d+'"':"")+' controls><source type="'+a.mime+'" src="'+a.url+'" /></video>'}else if("audio"===a.type)a.image&&a.image.src&&a.image.src!==a.icon?c+='<img class="wp-audio-cover" src="'+a.image.src+'" alt="'+a.filename+'" />':c+='<div class="mime-type-icon"><img src="'+a.icon+'" /><span>'+a.filename+"</span></div>",c+='<audio class="wp-audio-shortcode" width="100%" preload="none" controls><source type="'+a.mime+'" src="'+a.url+'" /></audio>';else{var e="image"===a.type?a.url:void 0;a.sizes&&(a.sizes.large?e=a.sizes.large.url:a.sizes.full&&(e=a.sizes.full.url)),c+=e?'<img src="'+e+'" alt="'+a.alt+'" />':'<div class="mime-type-icon"><img src="'+a.icon+'" /><span>'+a.filename+"</span></div>"}0<=c.search("<img ")?b.content.addClass("size-auto"):b.content.removeClass("size-auto"),b.content.show().html(c)},_resetContent:function(){var a=this;a.attachment=null,a.open_button.text(a.options.label_add),a.remove_button.hide(),a.content.hide().empty().removeClass("size-auto")},_getAttachment:function(){return this.attachment},_setAttachment:function(b){if(!b){if(this._resetContent(),!this.attachment)return;return this.element.val(null),this.element.trigger("change"),"function"==typeof this.options.clear&&this.options.clear.call(this),void a(document).trigger("wpMediaPicker.updateField",[null,this])}this._createContent(b),this.attachment&&this.attachment.id===b.id||("url"===this.options.store?this.element.val(b.url):this.element.val(b.id),this.element.trigger("change"),"function"==typeof this.options.change&&this.options.change.call(this),a(document).trigger("wpMediaPicker.updateField",[b,this]))},_getValue:function(){return this.attachment?"url"===this.options.store?this.attachment.url:this.attachment.id:""},_setValue:function(a){var b=this;d(a,b.options.store,function(a){b._setAttachment(a)},function(){b._setAttachment(null)})},open:function(){b.media.frame=this.frame,this.frame.open(),this.frame.$el.find(".media-frame-menu .media-menu-item.active").focus()},close:function(){this.frame.close()},attachment:function(a){if(void 0===a)return this._getAttachment();this._setAttachment(a)},value:function(a){if(void 0===a)return this._getValue();this._setValue(a)},frame:function(){return this.frame}},a.widget("wp.wpMediaPicker",g)}(jQuery,wp,_);